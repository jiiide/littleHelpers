<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    
    <title>Little Helpers</title>
    <style>
      header {
        background-color: #000;
        padding: 30px;
        text-align: center;
        font-size: 35px;
        color: white;
      }
      
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

    /* Modal Content */
      .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        -webkit-animation-name: animatetop;
        -webkit-animation-duration: 0.4s;
        animation-name: animatetop;
        animation-duration: 0.4s
        }

    /* Add Animation */
      @-webkit-keyframes animatetop {
      from {top:-300px; opacity:0} 
      to {top:0; opacity:1}
      }

      @keyframes animatetop {
      from {top:-300px; opacity:0}
      to {top:0; opacity:1}
      }

    /* The Close Button */
      .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }

      .modal-header {
        padding: 4px 16px;
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
      }

      .modal-body {padding: 4px 16px;}

      .modal-footer {
        padding: 2px 16px;
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
      }
      span.psw {
        float: right;
        padding-top: 16px;
      }
    </style>
  </head>
  
  
  <body onmousemove="addActivity()">
    <header>Little Helpers</header>
    
    <div class="container">
      <br>
      <h3>Enter Your ARC Professor Email (ex:doej@arc.losrios.edu)</h3>
      <br>
      <div class="form-group">
        <label for="pmail-input">Professor email:</label>
        <input type="text" class="form-control" id="pmail-input">
      </div>

      <button type="button" class="btn btn-primary" id="check-btn" onclick="emailMatch()">
      Enter
      </button>
      
    </div>
    <br>
    <br>
    
    <div id="modal-signup" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <h5>Email not in database. Check your email for a code and sign up.</h5>
            <span onclick="closeSignUp()" class="close" >&times;</span>
          </div>
          <div class="modal-body">
          
            <div class="form-group">
                <label for="access-input" >Enter code:</label>
                <input type="text" class="form-control" id="access-input" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="new-pw">Enter New Password:</label>
                <input type="password" value="" class="form-control" id="new-pw">
            </div>
            
            <div class="form-group">
                <label for="pw-recheck">Re-Enter New Password:</label>
                <input type="password" value="" class="form-control" id="pw-recheck">
            </div>
            <input type="checkbox" onclick="showPassword('new-pw');showPassword('pw-recheck')"> Show Passwords
            <br>
            <br>
            <button type="button" class="btn btn-primary" id="signup-btn" onclick="signUp()">
            Enter
            </button>
            <br>
            
          </div>
          <div class="modal-footer">
            <h5></h5>
          </div>
        </div>
    </div>
    
    <div id="modal-login" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <h5>Valid User</h5>
            <span onclick="closeLogin()" class="close">&times;</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <label for="pw-login">Enter password:</label>
                <input type="password" class="form-control" id="pw-login">
                <input type="checkbox" onclick="showPassword('pw-login')"> Show Password
            </div>
            
            <br>
            <button type="button" class="btn btn-primary" id="login-btn" onclick="checkPassword()">
            Enter
            </button>

          </div>
          <div class = "modal-body" style="background-color:#f1f1f1">
            <span class="psw" ><a href="javascript:forgotPassword(document.getElementById('pmail-input').value)">Forgot password?</a></span>
          </div>
        </div>
    </div>
    
    <div id="modal-forgot" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
          <div class="modal-header">
            <h5>A code has been sent to your email.</h5>
            <span onclick="closeForgot()" class="close" >&times;</span>
          </div>
          <div class="modal-body">
          
            <div class="form-group">
                <label for="access-input" >Enter code:</label>
                <input type="text" class="form-control" id="faccess-input" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="fnew-pw">Enter New Password:</label>
                <input type="password" value="" class="form-control" id="fnew-pw">
            </div>
            
            <div class="form-group">
                <label for="fpw-recheck">Re-Enter New Password:</label>
                <input type="password" value="" class="form-control" id="fpw-recheck">
            </div>
            <input type="checkbox" onclick="showPassword('fnew-pw');showPassword('fpw-recheck')"> Show Passwords
            <br>
            <br>
            <button type="button" class="btn btn-primary" id="forgot-btn" onclick="changePW()">
            Enter
            </button>
            <br>
            
          </div>
          <div class="modal-footer">
            <h5></h5>
          </div>
        </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script>

    function enterClick(inputId, btnId){
      var input = document.getElementById(inputId);
      input.addEventListener("keyup",function(e){
        if(e.keyCode === 13){
          e.preventDefault();
          document.getElementById(btnId).click();
        }
      })
    }

    enterClick("pmail-input", "check-btn"); //allows user to "enter" without clicking button
    enterClick("pw-recheck", "signup-btn");
    enterClick("fpw-recheck", "forgot-btn");
    enterClick("pw-login", "login-btn");
    
    function closeSignUp(){
      document.getElementById("modal-signup").style.display = "none";
    }
    
    function closeLogin(){
      document.getElementById("modal-login").style.display = "none";
    }
    
    function closeForgot(){
      document.getElementById("modal-forgot").style.display = "none";
    }
    
    function emailMatch(){
      // check if email is within database
      // if the email is in the database, direct to modalLogin
      // if the email is not in the database, direct to modalSignUp
      var pmail = document.getElementById("pmail-input").value;
      google.script.run.withSuccessHandler(function(isMatch){
          if(isMatch){
            document.getElementById("modal-login").style.display = "block";
          }
          else{
            emailCheck(document.getElementById("pmail-input").value)
          }   
      }).inDataBase(pmail);
    }
    
    function emailCheck(pmail){
      //check if email is a valid professor email
      google.script.run.withSuccessHandler(function(hasSent){
        if(hasSent){
          document.getElementById("modal-signup").style.display = "block";
        }
        else{
          alert("Please enter an ARC professor email.")
          document.getElementById("pmail-input").value = "";
        }
      }).isProfessor(pmail)
    }
    
    function signUp(){
      var user = document.getElementById("pmail-input").value;
      var accessInput = document.getElementById("access-input").value;
      var pwInput = document.getElementById("new-pw").value;
      var rePwInput = document.getElementById("pw-recheck").value;
      
      google.script.run.withSuccessHandler(function(acPWvalid){
        if(acPWvalid[0], acPWvalid[1]){
          alert("User successfully created. Redirecting to login.");
          document.getElementById("modal-login").style.display = "block";
          document.getElementById("modal-signup").style.display = "none";
          document.getElementById("modal-forgot").style.display = "none";
        }
        else if(!acPWvalid[0] || !acPWvalid[1]){
          alert("Either access code is invalid or passwords mismatch. Please try again.");
        }
      }).addUser(user, accessInput, pwInput, rePwInput);
    }
    
    function changePW(){
      var user = document.getElementById("pmail-input").value;
      var accessInput = document.getElementById("faccess-input").value;
      var pwInput = document.getElementById("fnew-pw").value;
      var rePwInput = document.getElementById("fpw-recheck").value;
      
      google.script.run.withSuccessHandler(function(acPWvalid){
        if(acPWvalid[0], acPWvalid[1]){
          alert("Password successfully updated. Redirecting to login.");
          document.getElementById("modal-login").style.display = "block";
          document.getElementById("modal-signup").style.display = "none";
          document.getElementById("modal-forgot").style.display = "none";
        }
        else if(!acPWvalid[0] || !acPWvalid[1]){
          alert("Either access code is invalid or passwords mismatch. Please try again.");
        }
      }).addUser(user, accessInput, pwInput, rePwInput);
    }
    
    function showPassword(pw) {
      var x = document.getElementById(pw);
      if (x.type === "password") {
        x.type = "text";
      } 
      else {
        x.type = "password";
      }
    }
    
    function forgotPassword(email){
      google.script.run.withSuccessHandler(function(hasSent){
        if(hasSent){
          document.getElementById("modal-forgot").style.display = "block";
        }
      }).sendCode(email);
    }
    
    function checkPassword(){
      var user = document.getElementById("pmail-input").value;
      var pwLogin = document.getElementById("pw-login").value;
      
      google.script.run.withSuccessHandler(function(match){
        if(match){
          google.script.run.grantAccess();
          google.script.run.withSuccessHandler(function(page){
              document.open();   //should work fine without this
              document.write(page);
              document.close();  //should work fine without this
          }).newPage('Index'); //for some reason this doesn't work
        }
        else{
          alert("Password mismatch. Please try again.");
        }
      }).checkUser(user, pwLogin)
    }
    
    var activityCount = 0;
    function addActivity(){
      activityCount++;
    }
    setInterval(function(){
      if (activityCount > 0){
        sessionIncrease();
        activityCount = 0;
      }
    }, 1000*60*10); //checks for activity every 10minutes
      
    function sessionIncrease(){
      google.script.run.extendSession();
    }
    </script>
  </body>
</html>


